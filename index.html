<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pendeteksi Cuaca WIB</title>
  <style>
    :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;margin:0}
    body{background:linear-gradient(180deg,#e9f2ff,#f7fbff);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .card{width:100%;max-width:780px;background:#fff;border-radius:12px;box-shadow:0 6px 30px rgba(20,40,80,0.08);padding:20px}
    h1{margin:0 0 8px;font-size:20px}
    .meta{color:#556; font-size:14px;margin-bottom:12px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    input[type=text]{flex:1;padding:10px;border:1px solid #ddd;border-radius:8px}
    button{padding:10px 14px;border-radius:8px;border:0;background:#007bff;color:#fff;cursor:pointer}
    button.alt{background:#6c757d}
    .row{display:flex;gap:12px;align-items:center}
    .weather-main{display:flex;gap:18px;align-items:center;flex-wrap:wrap;margin-top:12px}
    .info{min-width:160px}
    .big-temp{font-size:48px;font-weight:700}
    .small{color:#556}
    .hourly{overflow:auto;margin-top:14px;padding-top:10px;border-top:1px solid #f0f4fb}
    .hourly-item{display:inline-block;width:92px;padding:8px;margin-right:8px;border-radius:8px;background:#f8fbff;text-align:center}
    footer{margin-top:12px;font-size:13px;color:#667}
    .loading{color:#007bff}
  </style>
</head>
<body>
  <div class="card">
    <h1>Pendeteksi Cuaca WIB</h1>
    <div class="meta">Otomatis deteksi lokasi (atau pakai Cimahi). Data dari Open-Meteo (gratis, tanpa API key).</div>

    <div class="controls">
      <button id="btn-loc">üìç Ikuti Lokasi Saya</button>
      <button id="btn-cim" class="alt">üèôÔ∏è Gunakan Cimahi (WIB)</button>
      <div style="flex:1"></div>
      <div id="last-update" class="small">‚Äî</div>
    </div>

    <div id="status" class="small">Tekan <b>Ikuti Lokasi Saya</b> atau <b>Gunakan Cimahi</b> untuk mulai.</div>

    <div id="weather" style="display:none">
      <div class="weather-main">
        <div class="info">
          <div id="place" class="small"></div>
          <div id="local-time" class="small"></div>
          <div class="big-temp" id="temp">--¬∞C</div>
          <div id="condition" class="small"></div>
        </div>
        <div class="info small">
          <div>Kecepatan angin: <span id="winds">-- m/s</span></div>
          <div>Tekanan: <span id="pressure">-- hPa</span></div>
          <div>Curah hujan (1h): <span id="precip">-- mm</span></div>
        </div>
      </div>

      <div class="hourly" id="hourly"></div>

      <footer>
        Data diambil dari <a href="https://open-meteo.com" target="_blank">Open-Meteo</a>. Contoh kondisi saat ini untuk Cimahi: <span id="example-now">‚Äî</span>.
      </footer>
    </div>
  </div>

<script>
/*
  Simple Weather Detector
  - Uses Geolocation API (if diizinkan)
  - Fallback ke Cimahi coords
  - Uses Open-Meteo free API
  - Shows local time in Asia/Jakarta (WIB)
*/

const CIMAHI = { lat: -6.8975, lon: 107.5450, name: 'Cimahi, Indonesia' }; // fallback coords
const REFRESH_MS = 10 * 60 * 1000; // refresh tiap 10 menit

const btnLoc = document.getElementById('btn-loc');
const btnCim = document.getElementById('btn-cim');
const statusEl = document.getElementById('status');
const weatherEl = document.getElementById('weather');
const placeEl = document.getElementById('place');
const localTimeEl = document.getElementById('local-time');
const tempEl = document.getElementById('temp');
const condEl = document.getElementById('condition');
const windsEl = document.getElementById('winds');
const precipEl = document.getElementById('precip');
const pressureEl = document.getElementById('pressure');
const hourlyEl = document.getElementById('hourly');
const lastUpdateEl = document.getElementById('last-update');
const exampleNow = document.getElementById('example-now');

let currentCoords = null;
let refreshTimer = null;

btnLoc.addEventListener('click', () => {
  status('Mencari lokasi‚Ä¶ (izinkan Geolocation di browser)');
  if (!navigator.geolocation) {
    status('Geolocation tidak didukung di browser ini.');
    return;
  }
  navigator.geolocation.getCurrentPosition(pos => {
    const { latitude, longitude } = pos.coords;
    currentCoords = { lat: latitude, lon: longitude, name: 'Lokasi Anda' };
    fetchAndRender(currentCoords);
  }, err => {
    status('Gagal mendapatkan lokasi. Menggunakan Cimahi sebagai fallback.');
    useCimahi();
  }, { enableHighAccuracy: true, maximumAge: 60_000, timeout: 15_000 });
});

btnCim.addEventListener('click', () => {
  useCimahi();
});

function useCimahi() {
  currentCoords = { ...CIMAHI };
  fetchAndRender(currentCoords);
}

function status(msg) {
  statusEl.textContent = msg;
}

function setLastUpdate(ts) {
  lastUpdateEl.textContent = 'Terakhir: ' + new Date(ts).toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' });
}

async function fetchAndRender(coords) {
  clearInterval(refreshTimer);
  weatherEl.style.display = 'none';
  status('Mengambil data cuaca untuk: ' + coords.name + ' ‚Ä¶');

  try {
    // Build Open-Meteo URL (current + hourly temp + precipitation + weathercode + wind)
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${coords.lat}&longitude=${coords.lon}` +
                `&current_weather=true&hourly=temperature_2m,precipitation,windspeed_10m,weathercode&timezone=Asia%2FJakarta`;

    const r = await fetch(url);
    if (!r.ok) throw new Error('Gagal fetch data cuaca');

    const data = await r.json();

    // Current weather
    const cur = data.current_weather;
    const timeNow = cur?.time || data.hourly?.time?.[0];
    const temp = cur?.temperature ?? '‚Äî';
    const wind = cur?.windspeed ?? '‚Äî';
    const weatherCode = cur?.weathercode ?? null;
    const pressure = data.hourly?.surface_pressure ? (data.hourly.surface_pressure[0] || '‚Äî') : '‚Äî';
    // precipitation: Open-Meteo hourly precipitation available; take current hour index
    let precip = '‚Äî';
    if (data.hourly && data.hourly.time) {
      const idx = data.hourly.time.indexOf(timeNow);
      if (idx >= 0 && data.hourly.precipitation) precip = data.hourly.precipitation[idx];
    }

    // Render
    placeEl.textContent = coords.name + ` (lat:${coords.lat.toFixed(4)}, lon:${coords.lon.toFixed(4)})`;
    localTimeEl.textContent = 'Waktu (WIB): ' + new Date(timeNow).toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' });
    tempEl.textContent = temp + '¬∞C';
    condEl.textContent = weatherCodeToText(weatherCode);
    windsEl.textContent = wind + ' m/s';
    precipEl.textContent = precip + ' mm';
    pressureEl.textContent = pressure !== '‚Äî' ? pressure + ' hPa' : '‚Äî';

    // Hourly preview (next 12 jam)
    hourlyEl.innerHTML = '';
    if (data.hourly && data.hourly.time) {
      const times = data.hourly.time;
      const temps = data.hourly.temperature_2m || [];
      const precs = data.hourly.precipitation || [];
      const codes = data.hourly.weathercode || [];

      // find index of current time
      const startIdx = Math.max(0, times.indexOf(timeNow));
      for (let i = startIdx; i < Math.min(times.length, startIdx + 12); i++) {
        const t = new Date(times[i] + 'Z').toLocaleTimeString('id-ID', { timeZone: 'Asia/Jakarta', hour: '2-digit', minute: '2-digit' });
        const ti = document.createElement('div');
        ti.className = 'hourly-item';
        ti.innerHTML = `<div class="small">${t}</div>
                        <div style="font-weight:700">${temps[i] ?? '‚Äî'}¬∞C</div>
                        <div class="small">${weatherCodeToShort(codes[i])}</div>
                        <div class="small">üíß${precs[i] ?? '0'} mm</div>`;
        hourlyEl.appendChild(ti);
      }
    }

    status('');
    weatherEl.style.display = 'block';
    setLastUpdate(Date.now());
    // example display: include current condition (for Cimahi example)
    exampleNow.textContent = temp + '¬∞C, ' + weatherCodeToText(weatherCode) + ' (sumber: Open-Meteo).';

    // auto-refresh
    refreshTimer = setInterval(() => fetchAndRender(coords), REFRESH_MS);

  } catch (err) {
    console.error(err);
    status('Terjadi kesalahan saat mengambil data cuaca: ' + err.message);
  }
}

// Helper: map Open-Meteo weathercode to text
function weatherCodeToText(code){
  if (code == null) return 'Tidak tersedia';
  // simplified mapping (lihat open-meteo weathercode)
  const map = {
    0: 'Cerah',
    1: 'Cerah berawan',
    2: 'Berawan',
    3: 'Cerah/berawan tebal',
    45: 'Kabut',
    48: 'Kabut (deposit)',
    51: 'Hujan gerimis ringan',
    53: 'Hujan gerimis sedang',
    55: 'Hujan gerimis deras',
    61: 'Hujan ringan',
    63: 'Hujan sedang',
    65: 'Hujan lebat',
    71: 'Salju ringan',
    73: 'Salju sedang',
    75: 'Salju lebat',
    80: 'Hujan lokal ringan',
    81: 'Hujan lokal sedang',
    82: 'Hujan lokal lebat',
    95: 'Badai sedang',
    96: 'Badai petir (ringan)',
    99: 'Badai petir (berat)'
  };
  return map[code] ?? 'Kode cuaca ' + code;
}
function weatherCodeToShort(code){
  if (code == null) return '‚Äî';
  const shortMap = {
    0:'‚òÄÔ∏è',1:'‚õÖ',2:'‚òÅÔ∏è',3:'‚òÅÔ∏è',45:'üå´Ô∏è',48:'üå´Ô∏è',
    51:'üå¶Ô∏è',53:'üå¶Ô∏è',55:'üåßÔ∏è',61:'üåßÔ∏è',63:'üåßÔ∏è',65:'‚õàÔ∏è',
    71:'‚ùÑÔ∏è',73:'‚ùÑÔ∏è',75:'‚ùÑÔ∏è',80:'üåßÔ∏è',81:'üåßÔ∏è',82:'‚õàÔ∏è',95:'‚õàÔ∏è',96:'‚õàÔ∏è',99:'‚õàÔ∏è'
  };
  return shortMap[code] ?? 'üå§';
}

// Initial example fetch for Cimahi to show sample (and to provide an immediate example)
(async ()=> {
  try {
    const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${CIMAHI.lat}&longitude=${CIMAHI.lon}&current_weather=true&timezone=Asia%2FJakarta`);
    if (r.ok) {
      const d = await r.json();
      const cur = d.current_weather;
      if (cur) exampleNow.textContent = `${cur.temperature}¬∞C, ${weatherCodeToText(cur.weathercode)}`;
      // else leave as dash
    }
  } catch(e){ console.warn('example fetch failed', e) }
})();

</script>
</body>
</html>
